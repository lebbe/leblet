<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Settings</title>
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <!-- Leaflet Geocoder CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.0/dist/leaflet-geoman.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        background-color: #1a1a1a;
        color: #e0e0e0;
        min-height: 100vh;
        padding: 24px;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      h1 {
        font-size: 28px;
        margin-bottom: 32px;
        text-align: center;
      }

      .form-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #d0d0d0;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #333;
        border-radius: 4px;
        background-color: #242424;
        color: #e0e0e0;
        font-family: inherit;
        font-size: 14px;
        transition: border-color 0.2s;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #4a9eff;
        box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.1);
      }

      input::placeholder,
      textarea::placeholder {
        color: #666;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .form-row .form-group {
        margin-bottom: 0;
      }

      button {
        width: 100%;
        padding: 12px;
        background-color: #4a9eff;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 24px;
      }

      button:hover {
        background-color: #357abd;
      }

      button:active {
        transform: scale(0.98);
      }

      .info-text {
        font-size: 12px;
        color: #888;
        margin-top: 4px;
      }

      .error {
        color: #ff6b6b;
        padding: 12px;
        border-radius: 4px;
        background-color: rgba(255, 107, 107, 0.1);
        margin-bottom: 24px;
        display: none;
      }

      .error.show {
        display: block;
      }

      .success {
        color: #51cf66;
        padding: 12px;
        border-radius: 4px;
        background-color: rgba(81, 207, 102, 0.1);
        margin-bottom: 24px;
        display: none;
      }

      .success.show {
        display: block;
      }

      .url-container {
        background-color: #242424;
        border: 1px solid #333;
        border-radius: 4px;
        padding: 16px;
        margin-top: 24px;
        display: none;
      }

      .url-container.show {
        display: block;
      }

      .url-label {
        font-size: 12px;
        color: #888;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .url-display {
        background-color: #1a1a1a;
        border: 1px solid #333;
        padding: 12px;
        border-radius: 4px;
        font-size: 12px;
        color: #4a9eff;
        word-break: break-all;
        font-family: 'Monaco', 'Courier New', monospace;
        margin-bottom: 12px;
        max-height: 100px;
        overflow-y: auto;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .button-group button {
        margin-top: 0;
      }

      .copy-btn {
        background-color: #51cf66;
      }

      .copy-btn:hover {
        background-color: #40c057;
      }

      .entur-link {
        display: inline-block;
        padding: 8px 16px;
        background-color: #4a9eff;
        color: #fff;
        text-decoration: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
        margin-top: 4px;
      }

      .entur-link:hover {
        background-color: #357abd;
      }

      .location-picker {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 32px;
        margin-top: 24px;
      }

      .location-inputs {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .location-inputs .form-group {
        margin-bottom: 0;
      }

      .location-inputs input {
        width: 100%;
      }

      #map {
        min-height: 400px;
        border-radius: 4px;
        border: 1px solid #333;
        background-color: #242424;
      }

      /* Leaflet Geocoder search input styling */
      .leaflet-control-geocoder-form input {
        color: #000 !important;
        background-color: #fff !important;
      }

      .leaflet-control-geocoder-form input::placeholder {
        color: #999;
      }

      @media (max-width: 768px) {
        .location-picker {
          grid-template-columns: 1fr;
        }

        #map {
          min-height: 300px;
        }
        .form-row {
          grid-template-columns: 1fr;
        }

        h1 {
          font-size: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Dashboard Settings</h1>

      <div class="error" id="error-message"></div>
      <div class="success" id="success-message"></div>

      <!-- Location Picker -->
      <div class="location-picker">
        <div class="location-inputs">
          <h2 style="margin-bottom: 8px; font-size: 18px">Location</h2>
          <div class="form-group">
            <label for="location-latitude">Latitude</label>
            <input
              type="number"
              id="location-latitude"
              placeholder="e.g., 60.10"
              step="0.01"
              min="-90"
              max="90"
            />
          </div>
          <div class="form-group">
            <label for="location-longitude">Longitude</label>
            <input
              type="number"
              id="location-longitude"
              placeholder="e.g., 9.58"
              step="0.01"
              min="-180"
              max="180"
            />
          </div>
          <div class="form-group">
            <label for="location-altitude">Altitude (m)</label>
            <input
              type="number"
              id="location-altitude"
              placeholder="Fetched automatically"
              disabled
            />
            <div class="info-text">Updated when location changes</div>
          </div>
        </div>
        <div id="map"></div>
      </div>

      <form id="settings-form">
        <div class="form-group">
          <label for="station-input">Board URL</label>
          <textarea
            id="station-input"
            name="station-input"
            placeholder="Enter the full board URL (e.g., https://tavla.entur.no/Nc8XrEWestrOqa1JaHSR)"
            rows="4"
            required
          ></textarea>
          <div class="info-text">Copy the URL from tavla.entur.no</div>
          <a href="https://tavla.entur.no" target="_blank" class="entur-link"
            >Open Entur â†’</a
          >
        </div>

        <a
          href="#"
          id="generate-link"
          style="
            display: inline-block;
            width: 100%;
            padding: 12px;
            background-color: #4a9eff;
            color: #fff;
            text-align: center;
            text-decoration: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 24px;
          "
          onmouseover="this.style.backgroundColor='#357abd'"
          onmouseout="this.style.backgroundColor='#4a9eff'"
          >Generate Dashboard</a
        >

      <div class="url-container" id="url-container">
        <div class="url-label">Generated Dashboard URL</div>
        <div class="url-display" id="generated-url"></div>
        <div class="button-group">
          <button type="button" class="copy-btn" id="copy-btn">
            Copy to Clipboard
          </button>
          <button type="button" id="open-btn">Open Dashboard</button>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Geocoder JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
      // Form and UI variables
      const form = document.getElementById('settings-form')
      const errorDiv = document.getElementById('error-message')
      const successDiv = document.getElementById('success-message')

      // Location picker variables
      let map = null
      let marker = null
      const defaultLocation = [59.91, 10.75] // Oslo

      const latInput = document.getElementById('location-latitude')
      const lonInput = document.getElementById('location-longitude')
      const altInput = document.getElementById('location-altitude')

      // Initialize map on page load
      function initMap() {
        map = L.map('map', { attributionControl: false }).setView(
          defaultLocation,
          11
        )

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19,
        }).addTo(map)

        // Add marker at default location
        marker = L.marker(defaultLocation).addTo(map)
        latInput.value = defaultLocation[0].toFixed(4)
        lonInput.value = defaultLocation[1].toFixed(4)
        fetchAltitude(defaultLocation[0], defaultLocation[1])

        // Map click handler
        map.on('click', (e) => {
          const lat = e.latlng.lat
          const lon = e.latlng.lng
          updateLocation(lat, lon)
        })

        // Add geocoder control
        const geocoder = L.Control.geocoder({
          defaultMarkGeocode: false,
        })
          .on('markgeocode', (e) => {
            const lat = e.geocode.center.lat
            const lon = e.geocode.center.lng
            updateLocation(lat, lon)
          })
          .addTo(map)
      }

      function updateLocation(lat, lon) {
        lat = parseFloat(lat.toFixed(4))
        lon = parseFloat(lon.toFixed(4))

        // Update inputs
        latInput.value = lat
        lonInput.value = lon

        // Update marker
        if (marker) {
          marker.setLatLng([lat, lon])
        } else {
          marker = L.marker([lat, lon]).addTo(map)
        }

        // Center map
        map.setView([lat, lon], map.getZoom())

        // Fetch altitude
        fetchAltitude(lat, lon)
      }

      async function fetchAltitude(lat, lon) {
        try {
          const response = await fetch(
            `https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lon}`
          )
          const data = await response.json()
          if (data.elevation && data.elevation.length > 0) {
            altInput.value = Math.round(data.elevation[0])
          }
        } catch (error) {
          console.error('Error fetching altitude:', error)
        }
      }

      // Location input change handlers
      latInput.addEventListener('change', () => {
        const lat = parseFloat(latInput.value)
        const lon = parseFloat(lonInput.value)
        if (!isNaN(lat) && !isNaN(lon)) {
          updateLocation(lat, lon)
        }
      })

      lonInput.addEventListener('change', () => {
        const lat = parseFloat(latInput.value)
        const lon = parseFloat(lonInput.value)
        if (!isNaN(lat) && !isNaN(lon)) {
          updateLocation(lat, lon)
        }
      })

      // Initialize map when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        initMap()

        // Load saved settings from localStorage
        const saved = localStorage.getItem('dashboardSettings')
        if (saved) {
          const settings = JSON.parse(saved)
          const lat = settings.lat
          const lon = settings.lon
          if (lat && lon) {
            updateLocation(parseFloat(lat), parseFloat(lon))
          }
          document.getElementById('station-input').value =
            settings.stationInput || ''
        }

        // Update the generate link with restored values
        updateGenerateLink()
      })

      function showError(message) {
        errorDiv.textContent = message
        errorDiv.classList.add('show')
        successDiv.classList.remove('show')
      }

      function showSuccess(message) {
        successDiv.textContent = message
        successDiv.classList.add('show')
        errorDiv.classList.remove('show')
      }

      function generateDashboardUrl(lat, lon, transportUrl, altitude) {
        const dashboardUrl = new URL('/index.html', window.location.origin)
        dashboardUrl.searchParams.set('lat', lat)
        dashboardUrl.searchParams.set('lon', lon)
        dashboardUrl.searchParams.set('transport_url', transportUrl)
        if (altitude) {
          dashboardUrl.searchParams.set('alt', altitude)
        }
        return dashboardUrl.toString()
      }

      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            showSuccess('URL copied to clipboard!')
          })
          .catch(() => {
            showError('Failed to copy URL to clipboard')
          })
      }

      function displayGeneratedUrl(dashboardUrl) {
        const urlContainer = document.getElementById('url-container')
        const urlDisplay = document.getElementById('generated-url')
        const copyBtn = document.getElementById('copy-btn')
        const openBtn = document.getElementById('open-btn')

        urlDisplay.textContent = dashboardUrl
        urlContainer.classList.add('show')

        copyBtn.onclick = () => copyToClipboard(dashboardUrl)
        openBtn.onclick = () => {
          window.location.href = dashboardUrl
        }
      }

      function updateGenerateLink() {
        const mapLat = latInput.value
        const mapLon = lonInput.value
        const mapAlt = altInput.value
        const stationInput = document
          .getElementById('station-input')
          .value.trim()

        const generateLink = document.getElementById('generate-link')

        if (mapLat && mapLon && stationInput) {
          try {
            // Validate URL
            if (!stationInput.startsWith('http')) {
              generateLink.style.opacity = '0.5'
              generateLink.style.pointerEvents = 'none'
              return
            }

            new URL(stationInput)

            // Build dashboard URL
            const dashboardUrl = new URL('/index.html', window.location.origin)
            dashboardUrl.searchParams.set('lat', mapLat)
            dashboardUrl.searchParams.set('lon', mapLon)
            dashboardUrl.searchParams.set('transport_url', stationInput)
            if (mapAlt) {
              dashboardUrl.searchParams.set('alt', mapAlt)
            }

            // Save settings to localStorage
            const settings = {
              lat: mapLat,
              lon: mapLon,
              stationInput,
              transportUrl: stationInput,
            }
            localStorage.setItem('dashboardSettings', JSON.stringify(settings))

            // Update link
            generateLink.href = dashboardUrl.toString()
            generateLink.style.opacity = '1'
            generateLink.style.pointerEvents = 'auto'
          } catch (error) {
            generateLink.style.opacity = '0.5'
            generateLink.style.pointerEvents = 'none'
          }
        } else {
          generateLink.style.opacity = '0.5'
          generateLink.style.pointerEvents = 'none'
        }
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault()
        updateGenerateLink()
      })

      // Update link whenever location or station input changes
      latInput.addEventListener('change', updateGenerateLink)
      lonInput.addEventListener('change', updateGenerateLink)
      document
        .getElementById('station-input')
        .addEventListener('change', updateGenerateLink)
      document
        .getElementById('station-input')
        .addEventListener('input', updateGenerateLink)
    </script>
  </body>
</html>
